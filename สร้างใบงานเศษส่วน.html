<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global',
                scale: 1.40
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #F0F9FF;
        }
        .control-panel {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d1e9ff' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .worksheet-container {
            display: flex;
            flex-wrap: wrap;
            width: 210mm;
            height: 297mm; /* Fixed A4 height for screen preview */
            margin: auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
.problem-box {
    width: 50%;
    height: 50%;
    box-sizing: border-box;
    padding: 0.4cm;
    border: 1px solid #E5E7EB;
    display: flex;
    flex-direction: column;
}
        .problem-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .problem-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border-radius: 9999px; /* full circle */
            background-color: #3B82F6; /* blue-500 */
            color: white;
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .method-area {
    flex-grow: 1;
    border-radius: 0.5rem;
    margin-top: 0.5rem;
    width: 100%;
    height: 100%;
    background-image:
        linear-gradient(to right, #d1e9ff 1px, transparent 1px),
        linear-gradient(to bottom, #d1e9ff 1px, transparent 1px);
    background-size: 10% 10%;
    border: 1px solid #BFDBFE;
}
        .footer-info { border-top: 1px solid #D1D5DB; padding-top: 0.5rem; margin-top: 0.5rem; font-size: 0.9rem; }
        .btn-primary { background-color: #2563EB; color: white; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #1D4ED8; }
        .btn-secondary { background-color: #10B981; color: white; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #059669; }
        .btn-accent { background-color: #F59E0B; color: white; transition: background-color 0.3s; }
        .btn-accent:hover { background-color: #D97706; }
        
        #answer-key-modal {
            background-color: rgba(0,0,0,0.5);
        }
        .print-answers {
             display: none;
        }

        /* --- PRINT STYLES --- */
        @media print {
            body {
                background-color: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .control-panel, .header-banner, .button-container, #answer-key-modal {
                display: none !important;
            }
            #worksheet-pages {
                margin: 0 !important;
            }
            .worksheet-container {
                width: 100%;
                height: 100vh; /* Force full page height */
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                page-break-after: always;
            }
            .problem-box {
                border: 1px solid #ccc !important;
            }
            .print-answers {
                display: block !important;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="header-banner text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-blue-800">üìñ ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏´‡∏£‡∏£‡∏©‡∏≤ ‡∏Å‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ üìñ</h1>
        <p class="text-lg text-blue-600 mt-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡πÜ ‡∏õ‡∏£‡∏∞‡∏ñ‡∏°</p>
    </div>

    <div class="flex flex-col md:flex-row gap-8">
        <!-- Control Panel -->
        <div class="w-full md:w-1/3 lg:w-1/4 control-panel p-6 self-start">
            <h2 class="text-2xl font-bold text-blue-700 mb-6 border-b-2 border-blue-200 pb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</h2>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏à‡∏ó‡∏¢‡πå</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setOperation('+')" id="op-add" class="op-btn p-3 rounded-lg text-xl bg-blue-500 text-white shadow-md transition-transform transform hover:scale-105">+</button>
                    <button onclick="setOperation('-')" id="op-sub" class="op-btn p-3 rounded-lg text-xl bg-white text-gray-800 shadow-md transition-transform transform hover:scale-105">-</button>
                    <button onclick="setOperation('*')" id="op-mul" class="op-btn p-3 rounded-lg text-xl bg-white text-gray-800 shadow-md transition-transform transform hover:scale-105">√ó</button>
                    <button onclick="setOperation('/')" id="op-div" class="op-btn p-3 rounded-lg text-xl bg-white text-gray-800 shadow-md transition-transform transform hover:scale-105">√∑</button>
                </div>
            </div>

            <div class="mb-4">
                <label for="numProblems" class="block text-gray-700 font-bold mb-2">2. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠ (‡∏´‡∏≤‡∏£ 4 ‡∏•‡∏á‡∏ï‡∏±‡∏ß)</label>
                <input type="number" id="numProblems" value="4" min="4" step="4" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            <div class="border-t pt-4 mt-4">
                <label class="block text-gray-700 font-bold mb-2">3. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 1</label>
                <select id="type1" onchange="toggleRangeSettings(1)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="proper">‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ó‡πâ</option>
                    <option value="improper">‡πÄ‡∏®‡∏©‡πÄ‡∏Å‡∏¥‡∏ô</option>
                    <option value="mixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏•‡∏∞</option>
                </select>
                <div id="range-settings-1" class="mt-2 space-y-2">
                    <div id="num1-range-container">
                        <label class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏®‡∏©</label>
                        <div class="flex gap-2">
                            <input type="number" id="num1_min" value="1" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î">
                            <input type="number" id="num1_max" value="9" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                    <div id="den1-range-container">
                        <label class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏™‡πà‡∏ß‡∏ô</label>
                        <div class="flex gap-2">
                            <input type="number" id="den1_min" value="2" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î">
                            <input type="number" id="den1_max" value="10" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                    <div id="whole1-range-container" style="display: none;">
                        <label class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°</label>
                        <div class="flex gap-2">
                           <input type="number" id="whole1_min" value="1" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î">
                           <input type="number" id="whole1_max" value="9" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t pt-4 mt-4">
                <label class="block text-gray-700 font-bold mb-2">4. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 2</label>
                <select id="type2" onchange="toggleRangeSettings(2)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="proper">‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ó‡πâ</option>
                    <option value="improper">‡πÄ‡∏®‡∏©‡πÄ‡∏Å‡∏¥‡∏ô</option>
                    <option value="mixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏•‡∏∞</option>
                </select>
                <div id="range-settings-2" class="mt-2 space-y-2">
                    <div id="num2-range-container">
                        <label class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏®‡∏©</label>
                        <div class="flex gap-2">
                            <input type="number" id="num2_min" value="1" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î">
                            <input type="number" id="num2_max" value="9" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                    <div id="den2-range-container">
                        <label class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏™‡πà‡∏ß‡∏ô</label>
                        <div class="flex gap-2">
                           <input type="number" id="den2_min" value="2" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î">
                           <input type="number" id="den2_max" value="10" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                    <div id="whole2-range-container" style="display: none;">
                        <label class="text-sm text-gray-600">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°</label>
                        <div class="flex gap-2">
                           <input type="number" id="whole2_min" value="1" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î">
                           <input type="number" id="whole2_max" value="9" min="1" class="w-full p-1 border border-gray-200 rounded text-sm" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="generateBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 mt-6">
                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô
            </button>
        </div>

        <!-- Worksheet Preview -->
        <div class="w-full md:w-2/3 lg:w-3/4">
            <div class="button-container text-right mb-4 flex justify-end gap-2">
                 <button id="showAnswerKeyBtn" class="btn-accent font-bold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">
                    üßÆ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢
                </button>
                 <button onclick="window.print()" class="btn-secondary font-bold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">
                    üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏á‡∏≤‡∏ô
                </button>
            </div>
            <div id="worksheet-pages"></div>
        </div>
    </div>
    
    <!-- Answer Key Modal -->
    <div id="answer-key-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-2xl font-bold text-blue-800">‡πÄ‡∏â‡∏•‡∏¢‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</h3>
                    <button id="closeAnswerKeyBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="answer-key-content" class="text-lg space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Answer Key for Printing -->
    <div id="print-answer-key" class="print-answers"></div>


    <script>
        let currentOperation = '+';
        let generatedProblems = [];
        const generateBtn = document.getElementById('generateBtn');
        const worksheetPages = document.getElementById('worksheet-pages');
        const showAnswerKeyBtn = document.getElementById('showAnswerKeyBtn');
        const closeAnswerKeyBtn = document.getElementById('closeAnswerKeyBtn');
        const answerKeyModal = document.getElementById('answer-key-modal');
        const answerKeyContent = document.getElementById('answer-key-content');
        const printAnswerKeyContainer = document.getElementById('print-answer-key');

        const gcd = (a, b) => { a = Math.abs(a); b = Math.abs(b); return b === 0 ? a : gcd(b, a % b); };

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            if (min > max) [min, max] = [max, min]; // Swap if min > max
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function createFraction(type, numMin, numMax, denMin, denMax, wholeMin, wholeMax) {
            let whole = 0, num, den;
            let attempts = 0;
            
            do {
                den = getRandomInt(denMin, denMax);
                num = getRandomInt(numMin, numMax);
                attempts++;
                if (attempts > 100) { // Safety break
                    console.error("Could not generate a valid fraction with the given constraints.");
                    return { whole: 0, num: 0, den: 1 }; // Return a default value
                }
            } while (
                (type === 'proper' && num >= den) ||
                (type === 'mixed' && num >= den) ||
                (type === 'improper' && num <= den)
            );

            if (type === 'mixed') {
                whole = getRandomInt(wholeMin, wholeMax);
            }
            
            return { whole, num, den };
        }

        const toImproper = f => ({ num: f.whole * f.den + f.num, den: f.den });
        const toValue = f => f.whole + f.num / f.den;
        
        function simplify(f) {
            if (f.den === 0) return { whole: 0, num: 'Error', den: 1};
            const common = gcd(f.num, f.den);
            const num = f.num / common;
            const den = f.den / common;
            if (den === 1) return { whole: num, num: 0, den: 1};
            const whole = Math.floor(num / den);
            const newNum = num % den;
            if (newNum === 0) return { whole, num: 0, den: 1 };
            return { whole, num: newNum, den };
        }

        function formatFraction(f, isAnswer = false) {
            if (isAnswer) {
                if (f.num === 0 || f.num === 'Error') return `${f.whole}`;
                if (f.whole === 0) return `\\frac{${f.num}}{${f.den}}`;
            }
            if (f.whole > 0) return `${f.whole} \\frac{${f.num}}{${f.den}}`;
            return `\\frac{${f.num}}{${f.den}}`;
        }
        
        function calculate(f1, f2, op) {
            const imp1 = toImproper(f1);
            const imp2 = toImproper(f2);
            let resNum, resDen;
            
            switch(op) {
                case '+': resNum = imp1.num * imp2.den + imp2.num * imp1.den; resDen = imp1.den * imp2.den; break;
                case '-': resNum = imp1.num * imp2.den - imp2.num * imp1.den; resDen = imp1.den * imp2.den; break;
                case '*': resNum = imp1.num * imp2.num; resDen = imp1.den * imp2.den; break;
                case '/': resNum = imp1.num * imp2.den; resDen = imp1.den * imp2.num; if (resDen === 0) return {whole: 0, num: 'Invalid', den: 1}; break;
            }
            return simplify({num: resNum, den: resDen});
        }

        function setOperation(op) {
            currentOperation = op;
            document.querySelectorAll('.op-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-white', 'text-gray-800');
            });
            const selectedBtn = document.getElementById({ '+': 'op-add', '-': 'op-sub', '*': 'op-mul', '/': 'op-div' }[op]);
            selectedBtn.classList.remove('bg-white', 'text-gray-800');
            selectedBtn.classList.add('bg-blue-500', 'text-white');
        }

        function toggleRangeSettings(num) {
            const type = document.getElementById(`type${num}`).value;
            const wholeContainer = document.getElementById(`whole${num}-range-container`);
            wholeContainer.style.display = (type === 'mixed') ? 'block' : 'none';
        }

        function generateWorksheet() {
            generateBtn.disabled = true;
            generateBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';
            
            const numProblems = parseInt(document.getElementById('numProblems').value);
            const type1 = document.getElementById('type1').value;
            const num1Min = parseInt(document.getElementById('num1_min').value);
            const num1Max = parseInt(document.getElementById('num1_max').value);
            const den1Min = parseInt(document.getElementById('den1_min').value);
            const den1Max = parseInt(document.getElementById('den1_max').value);
            const whole1Min = parseInt(document.getElementById('whole1_min').value);
            const whole1Max = parseInt(document.getElementById('whole1_max').value);
            
            const type2 = document.getElementById('type2').value;
            const num2Min = parseInt(document.getElementById('num2_min').value);
            const num2Max = parseInt(document.getElementById('num2_max').value);
            const den2Min = parseInt(document.getElementById('den2_min').value);
            const den2Max = parseInt(document.getElementById('den2_max').value);
            const whole2Min = parseInt(document.getElementById('whole2_min').value);
            const whole2Max = parseInt(document.getElementById('whole2_max').value);

            if (numProblems % 4 !== 0 || numProblems <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏£ 4 ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
                generateBtn.disabled = false; generateBtn.textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô'; return;
            }

            const problemSet = new Set();
            generatedProblems = [];
            let attempts = 0;

            while (generatedProblems.length < numProblems && attempts < 2000) { // Increased safety break
                let f1 = createFraction(type1, num1Min, num1Max, den1Min, den1Max, whole1Min, whole1Max);
                let f2 = createFraction(type2, num2Min, num2Max, den2Min, den2Max, whole2Min, whole2Max);
                
                if (currentOperation === '-' && toValue(f1) < toValue(f2)) [f1, f2] = [f2, f1];
                if (currentOperation === '/' && toValue(f2) === 0) { attempts++; continue; }

                const opSymbol = currentOperation === '*' ? '\\times' : currentOperation === '/' ? '\\div' : currentOperation;
                const problemString = `${formatFraction(f1)} ${opSymbol} ${formatFraction(f2)}`;
                
                if (!problemSet.has(problemString)) {
                    const answer = calculate(f1, f2, currentOperation);
                    if (answer.num === 'Invalid') { attempts++; continue; }
                    
                    problemSet.add(problemString);
                    generatedProblems.push({
                        question: problemString,
                        answer: formatFraction(answer, true)
                    });
                }
                attempts++;
            }
            renderWorksheet(generatedProblems);
        }

        function renderWorksheet(problems) {
            worksheetPages.innerHTML = '';
            const numPages = Math.ceil(problems.length / 4);

            for (let p = 0; p < numPages; p++) {
                const page = document.createElement('div');
                page.className = 'worksheet-container mb-8';
                
                let pageContent = '';
                for (let i = 0; i < 4; i++) {
                    const problemIndex = p * 4 + i;
                    if (problemIndex < problems.length) {
                        pageContent += `
                            <div class="problem-box">
                                <div class="problem-content">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="problem-number">${problemIndex + 1}</div>
                                        <div class="text-xl md:text-2xl py-2">
                                            $${problems[problemIndex].question} = ?$
                                        </div>
                                    </div>
                                    <div class="flex-grow flex flex-col">
                                        <p class="font-semibold text-gray-600">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:</p>
                                        <div class="method-area"></div>
                                    </div>
                                </div>
                                <div class="footer-info">
                                    <div class="mb-2"><strong>‡∏ï‡∏≠‡∏ö:</strong>  _________________</div>
                                    <div><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> _________________________ <strong>‡∏ä‡∏±‡πâ‡∏ô:</strong> ____</div>
                                    <div><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ____</div>
                                </div>         
                            </div>`;
                    }
                }
                page.innerHTML = pageContent;
                worksheetPages.appendChild(page);
            }

            MathJax.typesetPromise().then(() => {
                generateBtn.disabled = false; generateBtn.textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô';
                prepareAnswerKey();
            }).catch((err) => console.log(err.message));
        }
        
        function prepareAnswerKey() {
            let keyHtml = '';
            let printKeyHtml = '<h1 class="text-2xl font-bold p-4">‡πÄ‡∏â‡∏•‡∏¢‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</h1><div class="p-4">';
            generatedProblems.forEach((prob, index) => {
                const line = `$${index + 1}.\\; ${prob.question} = ${prob.answer}$`;
                keyHtml += `<div>${line}</div>`;
                printKeyHtml += `<div class="text-xl mb-2">${line}</div>`;
            });
            printKeyHtml += '</div>';

            answerKeyContent.innerHTML = keyHtml;
            printAnswerKeyContainer.innerHTML = printKeyHtml;
            MathJax.typesetPromise([answerKeyContent, printAnswerKeyContainer]);
        }

        generateBtn.addEventListener('click', generateWorksheet);
        showAnswerKeyBtn.addEventListener('click', () => answerKeyModal.classList.replace('hidden', 'flex'));
        closeAnswerKeyBtn.addEventListener('click', () => answerKeyModal.classList.replace('flex', 'hidden'));
        answerKeyModal.addEventListener('click', (e) => {
            if (e.target === answerKeyModal) answerKeyModal.classList.replace('flex', 'hidden');
        });
        
        window.onload = () => {
            toggleRangeSettings(1);
            toggleRangeSettings(2);
            generateWorksheet();
        };
    </script>
</body>
</html>
